============================= test session starts ==============================
platform linux -- Python 3.12.12, pytest-8.4.2, pluggy-1.6.0 -- /usr/local/bin/python
cachedir: .pytest_cache
django: version: 5.2.6, settings: noesis2.settings.development (from env)
rootdir: /app
configfile: pytest.ini
plugins: cov-7.0.0, xdist-3.8.0, anyio-4.11.0, Faker-37.8.0, django-4.11.1
collecting ... collected 38 items / 37 deselected / 1 selected

ai_core/tests/test_views.py::test_ingestion_run_normalises_payload_before_dispatch FAILED [100%]

=================================== FAILURES ===================================
____________ test_ingestion_run_normalises_payload_before_dispatch _____________

client = <django.test.client.Client object at 0x73bf3b4fbe60>
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x73bf3b7958e0>
test_tenant_schema_name = 'autotest'

    def test_ingestion_run_normalises_payload_before_dispatch(
        client, monkeypatch, test_tenant_schema_name
    ):
        from ai_core.tests.doubles import MockTenantContext, MockTenant
        from django_tenants.middleware.main import TenantMainMiddleware
    
        monkeypatch.setattr("customers.tenant_context.TenantContext", MockTenantContext)
        monkeypatch.setattr(TenantMainMiddleware, "get_tenant", lambda self, model, hostname: MockTenant(schema_name=test_tenant_schema_name))
        monkeypatch.setattr(rate_limit, "check", lambda tenant, now=None: True)
        monkeypatch.setattr(views, "assert_case_active", lambda *args, **kwargs: None)
    
        captured: dict[str, object] = {}
    
        def _fake_partition(tenant, case, document_ids):
            captured["partition_args"] = (tenant, case, list(document_ids))
            return ["doc-trimmed"], []
    
        fake_vector = SimpleNamespace(
            id="vector-space",
            schema="rag",
            backend="pgvector",
            dimension=1536,
        )
        fake_resolution = SimpleNamespace(vector_space=fake_vector)
        fake_binding = SimpleNamespace(profile_id="standard", resolution=fake_resolution)
    
        def _fake_resolve(profile: str):
            captured["resolved_profile_input"] = profile
            return fake_binding
    
        dispatched: dict[str, object] = {}
    
        def _fake_delay(tenant, case, document_ids, profile_id, **kwargs):
            dispatched["args"] = (tenant, case, document_ids, profile_id)
            dispatched["kwargs"] = kwargs
    
        monkeypatch.setattr(views, "partition_document_ids", _fake_partition)
        monkeypatch.setattr(views, "resolve_ingestion_profile", _fake_resolve)
        monkeypatch.setattr(views.run_ingestion, "delay", _fake_delay)
    
        raw_id = str(uuid.uuid4())
>       response = client.post(
            "/ai/rag/ingestion/run/",
            data=json.dumps(
                {
                    "document_ids": [f" {raw_id} "],
                    "embedding_profile": " standard ",
                }
            ),
            content_type="application/json",
            **{
                META_TENANT_ID_KEY: test_tenant_schema_name,
                META_TENANT_SCHEMA_KEY: test_tenant_schema_name,
                META_CASE_ID_KEY: "case-test",
            },
        )

ai_core/tests/test_views.py:430: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.12/site-packages/django/test/client.py:1153: in post
    response = super().post(
/usr/local/lib/python3.12/site-packages/django/test/client.py:499: in post
    return self.generic(
/usr/local/lib/python3.12/site-packages/django/test/client.py:671: in generic
    return self.request(**r)
           ^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.12/site-packages/django/test/client.py:1087: in request
    self.check_exception(response)
/usr/local/lib/python3.12/site-packages/django/test/client.py:802: in check_exception
    raise exc_value
/usr/local/lib/python3.12/site-packages/django/core/handlers/exception.py:55: in inner
    response = get_response(request)
               ^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.12/site-packages/django/core/handlers/base.py:197: in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.12/site-packages/django/views/decorators/csrf.py:65: in _view_wrapper
    return view_func(request, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.12/site-packages/django/views/generic/base.py:105: in view
    return self.dispatch(request, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.12/site-packages/rest_framework/views.py:515: in dispatch
    response = self.handle_exception(exc)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.12/site-packages/rest_framework/views.py:475: in handle_exception
    self.raise_uncaught_exception(exc)
/usr/local/lib/python3.12/site-packages/rest_framework/views.py:486: in raise_uncaught_exception
    raise exc
/usr/local/lib/python3.12/site-packages/rest_framework/views.py:512: in dispatch
    response = handler(request, *args, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ai_core/views.py:1633: in post
    response = services.start_ingestion_run(payload, meta, idempotency_key)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ai_core/services/__init__.py:1251: in start_ingestion_run
    emit_ingestion_case_event(
ai_core/case_events.py:57: in emit_ingestion_case_event
    ingestion_run = _load_ingestion_run(tenant_identifier, case_id)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ai_core/case_events.py:32: in _load_ingestion_run
    return DocumentIngestionRun.objects.get(tenant_id=tenant_id, case=case_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.12/site-packages/django/db/models/manager.py:87: in manager_method
    return getattr(self.get_queryset(), name)(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.12/site-packages/django/db/models/query.py:629: in get
    num = len(clone)
          ^^^^^^^^^^
/usr/local/lib/python3.12/site-packages/django/db/models/query.py:366: in __len__
    self._fetch_all()
/usr/local/lib/python3.12/site-packages/django/db/models/query.py:1949: in _fetch_all
    self._result_cache = list(self._iterable_class(self))
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.12/site-packages/django/db/models/query.py:91: in __iter__
    results = compiler.execute_sql(
/usr/local/lib/python3.12/site-packages/django/db/models/sql/compiler.py:1621: in execute_sql
    cursor = self.connection.cursor()
             ^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.12/site-packages/django/utils/asyncio.py:26: in inner
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.12/site-packages/django/db/backends/base/base.py:320: in cursor
    return self._cursor()
           ^^^^^^^^^^^^^^
/usr/local/lib/python3.12/site-packages/django_tenants/postgresql_backend/base.py:144: in _cursor
    cursor = super()._cursor()
             ^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <DatabaseWrapper vendor='postgresql' alias='default'>, name = None

    def _cursor(self, name=None):
        self.close_if_health_check_failed()
>       self.ensure_connection()
E       RuntimeError: Database access not allowed, use the "django_db" mark, or the "db" or "transactional_db" fixtures to enable it.

/usr/local/lib/python3.12/site-packages/django/db/backends/base/base.py:296: RuntimeError
----------------------------- Captured stderr call -----------------------------
{"event": "Internal Server Error: /ai/rag/ingestion/run/", "exc_info": ["<class 'RuntimeError'>", "RuntimeError('Database access not allowed, use the \"django_db\" mark, or the \"db\" or \"transactional_db\" fixtures to enable it.')", "<traceback object at 0x73bf3b51f400>"], "service.name": "noesis2", "service.version": "unknown", "deployment.environment": "unknown", "trace_id": "[REDACTED]ddf02420fba741f03c825334c", "case_id": "case-test", "tenant_id": "autotest", "workflow_id": "case-test", "level": "error", "timestamp": "2025-12-02T08:07:28.488811Z", "span_id": null}
------------------------------ Captured log call -------------------------------
ERROR    django.request:log.py:253 Internal Server Error: /ai/rag/ingestion/run/
Traceback (most recent call last):
  File "/usr/local/lib/python3.12/site-packages/django/core/handlers/exception.py", line 55, in inner
    response = get_response(request)
               ^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/django/core/handlers/base.py", line 197, in _get_response
    response = wrapped_callback(request, *callback_args, **callback_kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/django/views/decorators/csrf.py", line 65, in _view_wrapper
    return view_func(request, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/django/views/generic/base.py", line 105, in view
    return self.dispatch(request, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/rest_framework/views.py", line 515, in dispatch
    response = self.handle_exception(exc)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/rest_framework/views.py", line 475, in handle_exception
    self.raise_uncaught_exception(exc)
  File "/usr/local/lib/python3.12/site-packages/rest_framework/views.py", line 486, in raise_uncaught_exception
    raise exc
  File "/usr/local/lib/python3.12/site-packages/rest_framework/views.py", line 512, in dispatch
    response = handler(request, *args, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/ai_core/views.py", line 1633, in post
    response = services.start_ingestion_run(payload, meta, idempotency_key)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/ai_core/services/__init__.py", line 1251, in start_ingestion_run
    emit_ingestion_case_event(
  File "/app/ai_core/case_events.py", line 57, in emit_ingestion_case_event
    ingestion_run = _load_ingestion_run(tenant_identifier, case_id)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/ai_core/case_events.py", line 32, in _load_ingestion_run
    return DocumentIngestionRun.objects.get(tenant_id=tenant_id, case=case_id)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/django/db/models/manager.py", line 87, in manager_method
    return getattr(self.get_queryset(), name)(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/django/db/models/query.py", line 629, in get
    num = len(clone)
          ^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/django/db/models/query.py", line 366, in __len__
    self._fetch_all()
  File "/usr/local/lib/python3.12/site-packages/django/db/models/query.py", line 1949, in _fetch_all
    self._result_cache = list(self._iterable_class(self))
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/django/db/models/query.py", line 91, in __iter__
    results = compiler.execute_sql(
              ^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/django/db/models/sql/compiler.py", line 1621, in execute_sql
    cursor = self.connection.cursor()
             ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/django/utils/asyncio.py", line 26, in inner
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/django/db/backends/base/base.py", line 320, in cursor
    return self._cursor()
           ^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/django_tenants/postgresql_backend/base.py", line 144, in _cursor
    cursor = super()._cursor()
             ^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/django/db/backends/base/base.py", line 296, in _cursor
    self.ensure_connection()
  File "/usr/local/lib/python3.12/site-packages/pytest_django/plugin.py", line 832, in _blocking_wrapper
    raise RuntimeError(
RuntimeError: Database access not allowed, use the "django_db" mark, or the "db" or "transactional_db" fixtures to enable it.
=============================== warnings summary ===============================
<frozen importlib._bootstrap>:488
<frozen importlib._bootstrap>:488
  <frozen importlib._bootstrap>:488: DeprecationWarning: builtin type SwigPyPacked has no __module__ attribute

<frozen importlib._bootstrap>:488
<frozen importlib._bootstrap>:488
  <frozen importlib._bootstrap>:488: DeprecationWarning: builtin type SwigPyObject has no __module__ attribute

<frozen importlib._bootstrap>:488
  <frozen importlib._bootstrap>:488: DeprecationWarning: builtin type swigvarlink has no __module__ attribute

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED ai_core/tests/test_views.py::test_ingestion_run_normalises_payload_before_dispatch - RuntimeError: Database access not allowed, use the "django_db" mark, or the "db" or "transactional_db" fixtures to enable it.
================= 1 failed, 37 deselected, 5 warnings in 5.39s =================
