============================= test session starts ==============================
platform linux -- Python 3.12.12, pytest-8.4.2, pluggy-1.6.0 -- /usr/local/bin/python
cachedir: .pytest_cache
django: version: 5.2.6, settings: noesis2.settings.development (from env)
rootdir: /app
configfile: pytest.ini
plugins: cov-7.0.0, xdist-3.8.0, anyio-4.11.0, Faker-37.8.0, django-4.11.1
collecting ... collected 38 items / 37 deselected / 1 selected

ai_core/tests/test_views.py::test_ingestion_run_rejects_blank_document_ids FAILED [100%]

=================================== FAILURES ===================================
________________ test_ingestion_run_rejects_blank_document_ids _________________

client = <django.test.client.Client object at 0x7234bde63ce0>
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7234bdead070>
test_tenant_schema_name = 'autotest'

    def test_ingestion_run_rejects_blank_document_ids(
        client, monkeypatch, test_tenant_schema_name
    ):
        from ai_core.tests.doubles import MockTenantContext
        monkeypatch.setattr("customers.tenant_context.TenantContext", MockTenantContext)
        monkeypatch.setattr(rate_limit, "check", lambda tenant, now=None: True)
        monkeypatch.setattr(views, "assert_case_active", lambda *args, **kwargs: None)
    
>       response = client.post(
            "/ai/rag/ingestion/run/",
            data=json.dumps({"document_ids": ["  "], "embedding_profile": "standard"}),
            content_type="application/json",
            **{
                META_TENANT_ID_KEY: test_tenant_schema_name,
                META_TENANT_SCHEMA_KEY: test_tenant_schema_name,
                META_CASE_ID_KEY: "case-test",
            },
        )

ai_core/tests/test_views.py:338: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/local/lib/python3.12/site-packages/django/test/client.py:1153: in post
    response = super().post(
/usr/local/lib/python3.12/site-packages/django/test/client.py:499: in post
    return self.generic(
/usr/local/lib/python3.12/site-packages/django/test/client.py:671: in generic
    return self.request(**r)
           ^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.12/site-packages/django/test/client.py:1087: in request
    self.check_exception(response)
/usr/local/lib/python3.12/site-packages/django/test/client.py:802: in check_exception
    raise exc_value
/usr/local/lib/python3.12/site-packages/django/core/handlers/exception.py:55: in inner
    response = get_response(request)
               ^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.12/site-packages/django/utils/deprecation.py:119: in __call__
    response = self.process_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.12/site-packages/django_tenants/middleware/main.py:45: in process_request
    tenant = self.get_tenant(domain_model, hostname)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.12/site-packages/django_tenants/middleware/main.py:29: in get_tenant
    domain = domain_model.objects.select_related('tenant').get(domain=hostname)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.12/site-packages/django/db/models/query.py:629: in get
    num = len(clone)
          ^^^^^^^^^^
/usr/local/lib/python3.12/site-packages/django/db/models/query.py:366: in __len__
    self._fetch_all()
/usr/local/lib/python3.12/site-packages/django/db/models/query.py:1949: in _fetch_all
    self._result_cache = list(self._iterable_class(self))
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.12/site-packages/django/db/models/query.py:91: in __iter__
    results = compiler.execute_sql(
/usr/local/lib/python3.12/site-packages/django/db/models/sql/compiler.py:1621: in execute_sql
    cursor = self.connection.cursor()
             ^^^^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.12/site-packages/django/utils/asyncio.py:26: in inner
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
/usr/local/lib/python3.12/site-packages/django/db/backends/base/base.py:320: in cursor
    return self._cursor()
           ^^^^^^^^^^^^^^
/usr/local/lib/python3.12/site-packages/django_tenants/postgresql_backend/base.py:144: in _cursor
    cursor = super()._cursor()
             ^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <DatabaseWrapper vendor='postgresql' alias='default'>, name = None

    def _cursor(self, name=None):
        self.close_if_health_check_failed()
>       self.ensure_connection()
E       RuntimeError: Database access not allowed, use the "django_db" mark, or the "db" or "transactional_db" fixtures to enable it.

/usr/local/lib/python3.12/site-packages/django/db/backends/base/base.py:296: RuntimeError
----------------------------- Captured stderr call -----------------------------
{"event": "Internal Server Error: /ai/rag/ingestion/run/", "exc_info": ["<class 'RuntimeError'>", "RuntimeError('Database access not allowed, use the \"django_db\" mark, or the \"db\" or \"transactional_db\" fixtures to enable it.')", "<traceback object at 0x7234bd820c80>"], "service.name": "noesis2", "service.version": "unknown", "deployment.environment": "unknown", "level": "error", "timestamp": "2025-12-02T08:04:42.063085Z", "trace_id": null, "span_id": null, "case_id": null, "tenant_id": null}
------------------------------ Captured log call -------------------------------
ERROR    django.request:log.py:253 Internal Server Error: /ai/rag/ingestion/run/
Traceback (most recent call last):
  File "/usr/local/lib/python3.12/site-packages/django/core/handlers/exception.py", line 55, in inner
    response = get_response(request)
               ^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/django/utils/deprecation.py", line 119, in __call__
    response = self.process_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/django_tenants/middleware/main.py", line 45, in process_request
    tenant = self.get_tenant(domain_model, hostname)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/django_tenants/middleware/main.py", line 29, in get_tenant
    domain = domain_model.objects.select_related('tenant').get(domain=hostname)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/django/db/models/query.py", line 629, in get
    num = len(clone)
          ^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/django/db/models/query.py", line 366, in __len__
    self._fetch_all()
  File "/usr/local/lib/python3.12/site-packages/django/db/models/query.py", line 1949, in _fetch_all
    self._result_cache = list(self._iterable_class(self))
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/django/db/models/query.py", line 91, in __iter__
    results = compiler.execute_sql(
              ^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/django/db/models/sql/compiler.py", line 1621, in execute_sql
    cursor = self.connection.cursor()
             ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/django/utils/asyncio.py", line 26, in inner
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/django/db/backends/base/base.py", line 320, in cursor
    return self._cursor()
           ^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/django_tenants/postgresql_backend/base.py", line 144, in _cursor
    cursor = super()._cursor()
             ^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.12/site-packages/django/db/backends/base/base.py", line 296, in _cursor
    self.ensure_connection()
  File "/usr/local/lib/python3.12/site-packages/pytest_django/plugin.py", line 832, in _blocking_wrapper
    raise RuntimeError(
RuntimeError: Database access not allowed, use the "django_db" mark, or the "db" or "transactional_db" fixtures to enable it.
=============================== warnings summary ===============================
<frozen importlib._bootstrap>:488
<frozen importlib._bootstrap>:488
  <frozen importlib._bootstrap>:488: DeprecationWarning: builtin type SwigPyPacked has no __module__ attribute

<frozen importlib._bootstrap>:488
<frozen importlib._bootstrap>:488
  <frozen importlib._bootstrap>:488: DeprecationWarning: builtin type SwigPyObject has no __module__ attribute

<frozen importlib._bootstrap>:488
  <frozen importlib._bootstrap>:488: DeprecationWarning: builtin type swigvarlink has no __module__ attribute

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED ai_core/tests/test_views.py::test_ingestion_run_rejects_blank_document_ids - RuntimeError: Database access not allowed, use the "django_db" mark, or the "db" or "transactional_db" fixtures to enable it.
================= 1 failed, 37 deselected, 5 warnings in 5.28s =================
