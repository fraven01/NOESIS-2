{% if reasoning or used_sources or debug_meta %}
<div class="mt-3 pt-3 border-t border-slate-100 flex flex-col gap-3"
    x-data="{ showReasoning: false, showSources: false, showPassages: false, showReferences: false }">

    <!-- Reasoning / Thinking Process -->
    {% if reasoning.analysis %}
    <div class="rounded-lg bg-slate-50 border border-slate-100 overflow-hidden">
        <button @click="showReasoning = !showReasoning"
            class="w-full flex items-center justify-between px-3 py-2 text-xs font-semibold text-slate-600 hover:bg-slate-100 transition-colors">
            <span class="flex items-center gap-2">
                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9.663 17h4.674M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                </svg>
                Thinking Process
            </span>
            <svg class="w-3 h-3 transform transition-transform" :class="showReasoning ? 'rotate-180' : ''" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
        </button>
        <div x-show="showReasoning" x-collapse
            class="px-3 pb-3 text-xs text-slate-500 leading-relaxed italic border-t border-slate-100 pt-2">
            {{ reasoning.analysis|linebreaks }}

            {% if reasoning.gaps %}
            <div class="mt-2 p-2 bg-amber-50 rounded border border-amber-100 text-amber-800 not-italic">
                <p class="font-bold mb-1">Knowledge Gaps:</p>
                <ul class="list-disc pl-4 space-y-0.5">
                    {% for gap in reasoning.gaps %}
                    <li>{{ gap }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Source Relevance Bars -->
    {% if used_sources %}
    <div class="rounded-lg bg-white border border-slate-100 overflow-hidden">
        <button @click="showSources = !showSources"
            class="w-full flex items-center justify-between px-3 py-2 text-xs font-semibold text-slate-600 hover:bg-slate-50 transition-colors">
            <span class="flex items-center gap-2">
                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                Evidence & Relevance
            </span>
            <svg class="w-3 h-3 transform transition-transform" :class="showSources ? 'rotate-180' : ''" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
        </button>
        <div x-show="showSources" x-collapse class="px-3 pb-3 border-t border-slate-100 pt-2">
            <div class="space-y-3">
                {% for source in used_sources %}
                <div class="space-y-1">
                    <div class="flex items-center justify-between text-[10px]">
                        <span class="font-medium text-slate-700">[{{ source.label }}]</span>
                        <span class="text-slate-400 font-mono">{{ source.score_percent }}%</span>
                    </div>
                    <div class="w-full bg-slate-100 rounded-full h-1.5">
                        <div class="bg-indigo-500 h-1.5 rounded-full transition-all duration-500"
                            style="width: {{ source.score_percent|default:0 }}%"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Debug Metadata Footer -->
    {% if show_debug and debug_meta %}
    {% if debug_meta.passages %}
    <div class="rounded-lg bg-white border border-slate-100 overflow-hidden">
        <button @click="showPassages = !showPassages"
            class="w-full flex items-center justify-between px-3 py-2 text-xs font-semibold text-slate-600 hover:bg-slate-50 transition-colors">
            <span class="flex items-center gap-2">
                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 7h16M4 12h16M4 17h16" />
                </svg>
                Passages
            </span>
            <svg class="w-3 h-3 transform transition-transform" :class="showPassages ? 'rotate-180' : ''" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
        </button>
        <div x-show="showPassages" x-collapse class="px-3 pb-3 border-t border-slate-100 pt-2 space-y-3">
            {% for passage in debug_meta.passages %}
            <div class="rounded-md border border-slate-100 bg-slate-50 p-2 text-[10px] text-slate-600 space-y-1">
                <div class="flex items-center justify-between">
                    <span class="font-semibold">ID: {{ passage.passage_id }}</span>
                    <span class="text-slate-400">Score: {{ passage.score|floatformat:3 }}</span>
                </div>
                {% if passage.section_path %}
                <div class="text-slate-400">Section: {{ passage.section_path|join:" > " }}</div>
                {% endif %}
                <div class="text-slate-400">Chunks: {{ passage.chunk_ids|join:", " }}</div>
                {% if passage.reference_labels %}
                <div class="text-slate-400">Reference Labels: {{ passage.reference_labels|join:", " }}</div>
                {% endif %}
                {% if passage.reference_ids %}
                <div class="text-slate-400">Reference IDs: {{ passage.reference_ids|join:", " }}</div>
                {% endif %}
                <div class="text-slate-500">{{ passage.text|linebreaksbr }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    {% if debug_meta.reference_expansion %}
    <div class="rounded-lg bg-white border border-slate-100 overflow-hidden">
        <button @click="showReferences = !showReferences"
            class="w-full flex items-center justify-between px-3 py-2 text-xs font-semibold text-slate-600 hover:bg-slate-50 transition-colors">
            <span class="flex items-center gap-2">
                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M7 7h10M7 12h10M7 17h10" />
                </svg>
                Reference Expansion
            </span>
            <svg class="w-3 h-3 transform transition-transform" :class="showReferences ? 'rotate-180' : ''"
                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
        </button>
        <div x-show="showReferences" x-collapse class="px-3 pb-3 border-t border-slate-100 pt-2 text-[10px] text-slate-500 space-y-1">
            <div>Reference IDs: {{ debug_meta.reference_expansion.reference_ids|join:", " }}</div>
            <div>Expanded Matches: {{ debug_meta.reference_expansion.expanded_matches }}</div>
            <div>Errors: {{ debug_meta.reference_expansion.errors }}</div>
            <div>Latency: {{ debug_meta.reference_expansion.took_ms }}ms</div>
        </div>
    </div>
    {% endif %}
    <div
        class="flex flex-wrap items-center gap-x-4 gap-y-1 text-[10px] text-slate-400 font-mono border-t border-slate-50 pt-2">
        <span title="Latency">‚è± {{ debug_meta.latency_ms|floatformat:0 }}ms</span>
        <span title="Usage">üìä {{ debug_meta.usage.total_tokens|default:"0" }} tokens</span>
        <span title="Model">ü§ñ {{ debug_meta.model }}</span>
        {% if debug_meta.cost_usd %}
        <span title="Cost">üí∞ ${{ debug_meta.cost_usd|floatformat:4 }}</span>
        {% endif %}
        {% if debug_meta.cache_hit %}
        <span class="text-emerald-500 font-bold">‚ö° CACHE HIT</span>
        {% endif %}
    </div>
    {% endif %}

    <!-- Suggested Follow-ups -->
    {% if suggested_followups %}
    <div class="flex flex-wrap gap-2 mt-1">
        {% for followup in suggested_followups %}
        <button
            class="px-2 py-1 bg-white border border-indigo-100 rounded-full text-[10px] text-indigo-600 hover:bg-indigo-50 hover:border-indigo-300 transition-all shadow-sm"
            hx-post="{% url 'chat-submit' %}" hx-vals='{"message": "{{ followup }}"}' hx-target="#chat-history"
            hx-swap="beforeend">
            {{ followup }}
        </button>
        {% endfor %}
    </div>
    {% endif %}

</div>
{% endif %}
