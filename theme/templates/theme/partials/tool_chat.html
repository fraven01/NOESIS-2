<div class="h-[calc(100vh-12rem)] max-w-5xl mx-auto" data-rag-chat-root>
    <!-- Chat Area (Full Width) -->
    <div class="flex flex-col h-full">
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col h-full overflow-hidden">

            <!-- Chat History -->
            <div id="chat-history" class="flex-1 overflow-y-auto p-6 space-y-6 bg-slate-50">
                <!-- Welcome Message -->
                <div class="flex items-start gap-4">
                    <div
                        class="flex-shrink-0 h-8 w-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold text-xs">
                        AI</div>
                    <div
                        class="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm border border-slate-100 text-sm text-slate-700 max-w-[80%]">
                        <p>Hello! I'm your RAG assistant. How can I help you analyze your documents today?</p>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 bg-white border-t border-slate-200">
                <form hx-post="{% url 'chat-submit' %}" hx-target="#chat-history" hx-swap="beforeend" class="relative"
                    data-rag-chat-form>
                    {% csrf_token %}
                    <!-- Hidden inputs handled below/dynamically -->
                    <input type="hidden" name="tenant_id" value="{{ tenant_id }}">
                    <input type="hidden" name="tenant_schema" value="{{ tenant_schema }}">

                    <div class="relative rounded-md shadow-sm">
                        <textarea name="message" rows="1"
                            class="form-textarea block w-full rounded-xl border-slate-300 pl-4 pr-12 py-3 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm resize-none"
                            placeholder="Type your message..."
                            onkeydown="if(event.keyCode == 13 && !event.shiftKey) { event.preventDefault(); this.form.requestSubmit(); }"></textarea>

                        <button type="submit"
                            class="absolute bottom-2 right-2 inline-flex items-center p-1.5 border border-transparent rounded-full shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                            </svg>
                        </button>
                    </div>
                    <!-- Unified Context managed globally -->
                    <div class="mt-2 space-y-2 px-1">
                        <div class="flex flex-wrap items-center gap-3">
                            <div class="flex items-center gap-2">
                                <label for="chat-thread" class="text-xs text-slate-500">Thread</label>
                                <input id="chat-thread" name="thread_id" value="{{ thread_id }}"
                                    class="rounded border-slate-300 text-xs text-slate-600 focus:border-indigo-500 focus:ring-indigo-500">
                                <button type="button" id="chat-thread-reset"
                                    class="rounded border border-slate-300 bg-white px-2 py-1 text-xs text-slate-600 hover:bg-slate-50">
                                    New
                                </button>
                            </div>

                            <!-- Local Context Overrides -->
                            <div class="flex items-center gap-2">
                                <!-- Collection Select -->
                                <div class="flex items-center gap-2">
                                    <label class="text-[10px] text-slate-400 uppercase tracking-wider">Scope</label>
                                    <select name="chat_scope"
                                        class="rounded border-slate-300 text-xs text-slate-600 focus:border-indigo-500 focus:ring-indigo-500 py-1 pl-2 pr-8 max-w-[150px]">
                                        <option value="collection" {% if chat_scope == "collection" %}selected{% endif %}>
                                            Collections only
                                        </option>
                                        <option value="case" {% if chat_scope == "case" %}selected{% endif %}>
                                            Cases only
                                        </option>
                                        <option value="global" {% if chat_scope == "global" %}selected{% endif %}>
                                            All Collections & Cases
                                        </option>
                                    </select>
                                </div>
                                <select name="collection_id"
                                    class="rounded border-slate-300 text-xs text-slate-600 focus:border-indigo-500 focus:ring-indigo-500 py-1 pl-2 pr-8 max-w-[150px]">
                                    <option value="">All Collections</option>
                                    {% for c in collection_options %}
                                    <option value="{{ c.id }}" {% if c.id == active_collection_id %}selected{% endif %}>
                                        {{ c.label|truncatechars:20 }}
                                    </option>
                                    {% endfor %}
                                </select>

                                <span class="text-slate-300">|</span>

                                <!-- Case Select (Simplified, assumes we only have ID context or Global) -->
                                <div class="relative">
                                    <!-- Note: Full Case options are not currently passed to tool_chat to save query overhead. 
                                          If needed, we can fetch them. For now, showing current ID or All. 
                                          We'll use a simple input/display or a select if options were available. 
                                          Given user request, let's allow entering a case ID or clearing it, essentially. 
                                          Or rely on global context for Case switching and local for Collection.
                                          Wait, user asked for "selecting created Collections OR Cases".
                                          We have collection_options. We don't have case_options here yet.
                                          Using a text input for Case ID fallback or just displaying it if set.
                                          Ideally we'd have case_options too. Let's stick to Collection dropdown + Case ID display for now 
                                          unless I fetch case options too.
                                          Actually, let's keep Case ID as hidden/display for now to avoid perf hit, 
                                          but Collection is the main request. 
                                     -->
                                    <input type="text" name="case_id" value="{{ case_id|default:'' }}"
                                        placeholder="All Cases"
                                        class="rounded border-slate-300 text-xs text-slate-600 focus:border-indigo-500 focus:ring-indigo-500 py-1 px-2 w-24"
                                        title="Case ID (Leave empty for Global)">
                                </div>
                            </div>
                        </div>
                        <p class="text-xs text-slate-400">Press Enter to send, Shift + Enter for new line</p>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
