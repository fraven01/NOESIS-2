<div class="h-[calc(100vh-12rem)] max-w-5xl mx-auto" data-rag-chat-root>
    <!-- Chat Area (Full Width) -->
    <div class="flex flex-col h-full">
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col h-full overflow-hidden">

            <!-- Chat History -->
            <div id="chat-history" class="flex-1 overflow-y-auto p-6 space-y-6 bg-slate-50">
                <!-- Welcome Message -->
                <div class="flex items-start gap-4">
                    <div
                        class="flex-shrink-0 h-8 w-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold text-xs">
                        AI</div>
                    <div
                        class="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm border border-slate-100 text-sm text-slate-700 max-w-[80%]">
                        <p>Hello! I'm your RAG assistant. How can I help you analyze your documents today?</p>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 bg-white border-t border-slate-200">
                <form hx-post="{% url 'chat-submit' %}" hx-target="#chat-history" hx-swap="beforeend" class="relative"
                    data-rag-chat-form>
                    {% csrf_token %}
                    <!-- Hidden inputs handled below/dynamically -->
                    <input type="hidden" name="tenant_id" value="{{ tenant_id }}">
                    <input type="hidden" name="tenant_schema" value="{{ tenant_schema }}">

                    <div class="relative rounded-md shadow-sm">
                        <textarea name="message" rows="1"
                            class="form-textarea block w-full rounded-xl border-slate-300 pl-4 pr-12 py-3 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm resize-none"
                            placeholder="Type your message..."
                            onkeydown="if(event.keyCode == 13 && !event.shiftKey) { event.preventDefault(); this.form.requestSubmit(); }"></textarea>

                        <button type="submit"
                            class="absolute bottom-2 right-2 inline-flex items-center p-1.5 border border-transparent rounded-full shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                            </svg>
                        </button>
                    </div>
                    <!-- Unified Context managed globally -->
                    <div class="mt-2 space-y-2 px-1">
                        <div class="flex flex-wrap items-center gap-3">
                            <div class="flex items-center gap-2">
                                <label for="chat-thread" class="text-xs text-slate-500">Thread</label>
                                <input id="chat-thread" name="thread_id" value="{{ thread_id }}"
                                    class="rounded border-slate-300 text-xs text-slate-600 focus:border-indigo-500 focus:ring-indigo-500">
                                <button type="button" id="chat-thread-reset"
                                    class="rounded border border-slate-300 bg-white px-2 py-1 text-xs text-slate-600 hover:bg-slate-50">
                                    New
                                </button>
                            </div>

                            <!-- Local Context Overrides -->
                            <div class="flex items-center gap-2">
                                <!-- Collection Select -->
                                <div class="flex items-center gap-2">
                                    <label class="text-[10px] text-slate-400 uppercase tracking-wider">Scope</label>
                                    <select name="chat_scope"
                                        class="rounded border-slate-300 text-xs text-slate-600 focus:border-indigo-500 focus:ring-indigo-500 py-1 pl-2 pr-8 max-w-[150px]">
                                        <option value="collection" {% if chat_scope == "collection" %}selected{% endif %}>
                                            Collections only
                                        </option>
                                        <option value="case" {% if chat_scope == "case" %}selected{% endif %}>
                                            Cases only
                                        </option>
                                        <option value="global" {% if chat_scope == "global" %}selected{% endif %}>
                                            All Collections & Cases
                                        </option>
                                    </select>
                                </div>
                                <select name="collection_id"
                                    class="rounded border-slate-300 text-xs text-slate-600 focus:border-indigo-500 focus:ring-indigo-500 py-1 pl-2 pr-8 max-w-[150px]">
                                    <option value="">All Collections</option>
                                    {% for c in collection_options %}
                                    <option value="{{ c.id }}" {% if c.id == active_collection_id %}selected{% endif %}>
                                        {{ c.label|truncatechars:20 }}
                                    </option>
                                    {% endfor %}
                                </select>

                                <span class="text-slate-300">|</span>

                                <!-- Case Select -->
                                <select name="case_id"
                                    class="rounded border-slate-300 text-xs text-slate-600 focus:border-indigo-500 focus:ring-indigo-500 py-1 pl-2 pr-8 max-w-[150px]">
                                    <option value="">All Cases</option>
                                    {% for c in case_options %}
                                    <option value="{{ c.id }}" {% if c.id == active_case_id %}selected{% endif %}>
                                        {{ c.label|truncatechars:20 }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <details class="ml-auto">
                                <summary class="list-none cursor-pointer">
                                    <span class="inline-flex items-center gap-1 rounded border border-slate-200 bg-white px-2 py-1 text-xs text-slate-600 hover:border-indigo-300 hover:text-indigo-700">
                                        &#9881; Tuning
                                    </span>
                                </summary>
                                <div class="mt-2 rounded-lg border border-slate-200 bg-white p-3 shadow-sm">
                                    <p class="text-[10px] uppercase tracking-wider text-slate-400 mb-2">Retrieval Params (Dev)</p>
                                    <div class="grid grid-cols-2 gap-2 text-xs text-slate-600">
                                        <label class="flex flex-col gap-1">
                                            alpha
                                            <input name="alpha" type="number" step="0.05" min="0" max="1" value="0.5"
                                                class="rounded border-slate-300 px-2 py-1 text-xs focus:border-indigo-500 focus:ring-indigo-500">
                                        </label>
                                        <label class="flex flex-col gap-1">
                                            top_k
                                            <input name="top_k" type="number" min="1" max="50" value="5"
                                                class="rounded border-slate-300 px-2 py-1 text-xs focus:border-indigo-500 focus:ring-indigo-500">
                                        </label>
                                        <label class="flex flex-col gap-1">
                                            min_sim
                                            <input name="min_sim" type="number" step="0.05" min="0" max="1" value="0.0"
                                                class="rounded border-slate-300 px-2 py-1 text-xs focus:border-indigo-500 focus:ring-indigo-500">
                                        </label>
                                        <label class="flex flex-col gap-1">
                                            max_candidates
                                            <input name="max_candidates" type="number" min="1" value="50"
                                                class="rounded border-slate-300 px-2 py-1 text-xs focus:border-indigo-500 focus:ring-indigo-500">
                                        </label>
                                        <label class="flex flex-col gap-1">
                                            vec_limit
                                            <input name="vec_limit" type="number" min="1" value="50"
                                                class="rounded border-slate-300 px-2 py-1 text-xs focus:border-indigo-500 focus:ring-indigo-500">
                                        </label>
                                        <label class="flex flex-col gap-1">
                                            lex_limit
                                            <input name="lex_limit" type="number" min="1" value="20"
                                                class="rounded border-slate-300 px-2 py-1 text-xs focus:border-indigo-500 focus:ring-indigo-500">
                                        </label>
                                        <label class="flex flex-col gap-1">
                                            trgm_limit
                                            <input name="trgm_limit" type="number" step="0.05" min="0" max="1" value="0.3"
                                                class="rounded border-slate-300 px-2 py-1 text-xs focus:border-indigo-500 focus:ring-indigo-500">
                                        </label>
                                        <label class="flex flex-col gap-1">
                                            diversify_strength
                                            <input name="diversify_strength" type="number" step="0.05" min="0" max="1" value="0.0"
                                                class="rounded border-slate-300 px-2 py-1 text-xs focus:border-indigo-500 focus:ring-indigo-500">
                                        </label>
                                    </div>
                                </div>
                            </details>
                        </div>
                        <p class="text-xs text-slate-400">Press Enter to send, Shift + Enter for new line</p>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
