<!-- DEBUG_INFO: tenant_id={{ tenant_id }}, tenant_schema={{ tenant_schema }}, collections_count={{ collections|length }} -->
<div class="h-full flex flex-col" x-data="{
    selectedCollection: '{{ query_defaults.collection|default:'' }}',
    searchTerm: '{{ query_defaults.q|default:'' }}',
    workflowFilter: '{{ query_defaults.workflow|default:'' }}',
    limit: '{{ query_defaults.limit|default:'10' }}',
    latestOnly: {{ query_defaults.latest|default:'true' }},
    showRetired: {{ query_defaults.show_retired|default:'false' }},
    
    updateFilters() {
        const params = new URLSearchParams();
        if (this.selectedCollection) params.set('collection', this.selectedCollection);
        if (this.searchTerm) params.set('q', this.searchTerm);
        if (this.workflowFilter) params.set('workflow', this.workflowFilter);
        params.set('limit', this.limit);
        params.set('latest', this.latestOnly ? '1' : '0');
        params.set('show_retired', this.showRetired ? '1' : '0');
        
        htmx.ajax('GET', '{% url 'document_explorer' %}?' + params.toString(), {
            target: '#workspace-content',
            swap: 'innerHTML'
        });
    }
}">
    <!-- Header -->
    <div class="mb-6 flex items-center justify-between">
        <div>
            <h2 class="text-2xl font-bold text-slate-900">Document Explorer</h2>
            <p class="text-sm text-slate-500">Inspect collections, metadata, and document lifecycles.</p>
        </div>
        <div class="flex gap-2">
            <span class="inline-flex items-center rounded-md bg-slate-100 px-2 py-1 text-xs font-medium text-slate-600">
                Tenant: {{ tenant_id }}
            </span>
            <span class="inline-flex items-center rounded-md bg-slate-100 px-2 py-1 text-xs font-medium text-slate-600">
                Schema: {{ tenant_schema }}
            </span>
        </div>
    </div>

    <div class="flex-1 grid grid-cols-1 lg:grid-cols-12 gap-6 min-h-0">
        <!-- Left Column: Filters & Collections -->
        <div class="lg:col-span-4 flex flex-col gap-4 overflow-y-auto pr-2">
            <!-- Filters -->
            <div class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm space-y-4">
                <h3 class="font-semibold text-slate-900">Filters</h3>

                <div class="space-y-1">
                    <label class="text-xs font-medium text-slate-700">Collection</label>
                    <select x-model="selectedCollection" @change="updateFilters()"
                        class="block w-full rounded-md border-slate-300 text-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="">All Collections</option>
                        {% for collection in collections %}
                        {% if collection.selector == selected_collection_identifier %}
                        <option value="{{ collection.selector }}" selected>
                            {{ collection.name }} ({{ collection.key }})
                        </option>
                        {% else %}
                        <option value="{{ collection.selector }}">
                            {{ collection.name }} ({{ collection.key }})
                        </option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>

                <div class="space-y-1">
                    <label class="text-xs font-medium text-slate-700">Search</label>
                    <input type="text" x-model="searchTerm" @keydown.enter="updateFilters()"
                        placeholder="Doc ID, Title..."
                        class="block w-full rounded-md border-slate-300 text-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>

                <div class="space-y-1">
                    <label class="text-xs font-medium text-slate-700">Workflow ID</label>
                    <input type="text" x-model="workflowFilter" @keydown.enter="updateFilters()"
                        placeholder="e.g. web-search"
                        class="block w-full rounded-md border-slate-300 text-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <div class="space-y-1">
                        <label class="text-xs font-medium text-slate-700">Limit</label>
                        <select x-model="limit" @change="updateFilters()"
                            class="block w-full rounded-md border-slate-300 text-sm focus:border-indigo-500 focus:ring-indigo-500">
                            {% for option in limit_options %}
                            <option value="{{ option }}">{{ option }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="flex flex-col items-start gap-1 pb-2">
                        <label class="inline-flex items-center gap-2 text-sm text-slate-700 cursor-pointer">
                            <input type="checkbox" x-model="latestOnly" @change="updateFilters()"
                                class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
                            <span class="text-xs">Latest Only</span>
                        </label>
                        <label class="inline-flex items-center gap-2 text-sm text-slate-700 cursor-pointer">
                            <input type="checkbox" x-model="showRetired" @change="updateFilters()"
                                class="rounded border-slate-300 text-amber-600 focus:ring-amber-500">
                            <span class="text-xs text-amber-700">Show Retired</span>
                        </label>
                    </div>
                </div>

                <button @click="updateFilters()"
                    class="w-full rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500">
                    Apply Filters
                </button>
            </div>

            <!-- Collection Info (if selected) -->
            {% if selected_collection %}
            <div class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm space-y-3">
                <h3 class="font-semibold text-slate-900">Active Collection</h3>
                <div class="text-xs space-y-2">
                    <div class="flex justify-between">
                        <span class="text-slate-500">Name</span>
                        <span class="font-medium text-slate-900">{{ selected_collection.name }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-500">Key</span>
                        <span class="font-mono text-slate-900">{{ selected_collection.key }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-500">ID</span>
                        <span class="font-mono text-slate-900 truncate max-w-[150px]"
                            title="{{ selected_collection.collection_id }}">{{ selected_collection.collection_id
                            }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-500">Type</span>
                        <span class="text-slate-900">{{ selected_collection.type|default:"—" }}</span>
                    </div>
                    {% if selected_collection.case %}
                    <div class="pt-2 border-t border-slate-100">
                        <p class="text-slate-500 mb-1">Case Context</p>
                        <div class="flex items-center gap-2">
                            <span class="bg-slate-100 px-1.5 py-0.5 rounded font-mono">{{
                                selected_collection.case.external_id }}</span>
                            <span class="truncate">{{ selected_collection.case.title }}</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}


        </div>

        <!-- Right Column: Document List -->
        <div class="lg:col-span-8 overflow-y-auto pr-2 space-y-4">
            {% if documents_error %}
            <div class="rounded-md bg-red-50 p-4 text-sm text-red-700 border border-red-200">
                {{ documents_error }}
            </div>
            {% endif %}

            {% if documents %}
            <div class="flex items-center justify-between">
                <p class="text-sm text-slate-600">
                    Showing {{ document_summary.displayed }} of {{ document_summary.fetched }} documents
                </p>
                {% if next_query %}
                <button hx-get="{% url 'document_explorer' %}?{{ next_query|urlencode }}" hx-target="#workspace-content"
                    class="text-sm font-medium text-indigo-600 hover:text-indigo-500">
                    Load More &rarr;
                </button>
                {% endif %}
            </div>

            <div class="space-y-4">
                {% for doc in documents %}
                <article
                    class="rounded-xl border border-slate-200 bg-white p-5 shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex-1 space-y-2">
                            <!-- Title & Badges -->
                            <div class="flex items-start gap-2 flex-wrap">
                                <h3 class="text-lg font-semibold text-slate-900 leading-tight flex-1 min-w-0">
                                    {{ doc.title }}
                                </h3>
                                <span
                                    class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium {% if doc.lifecycle_state == 'active' %}bg-green-100 text-green-700{% elif doc.lifecycle_state == 'archived' %}bg-amber-100 text-amber-700{% else %}bg-slate-100 text-slate-600{% endif %}">
                                    {{ doc.lifecycle_state }}
                                </span>
                            </div>

                            <!-- Origin URL -->
                            {% if doc.origin_uri %}
                            <p class="text-sm text-indigo-600 hover:text-indigo-500 truncate">
                                <a href="{{ doc.origin_uri }}" target="_blank"
                                    class="hover:underline flex items-center gap-1">
                                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                    </svg>
                                    <span class="truncate">{{ doc.origin_uri }}</span>
                                </a>
                            </p>
                            {% endif %}

                            <!-- IDs & Workflow -->
                            <div class="flex items-center gap-3 text-xs text-slate-500 font-mono flex-wrap">
                                <span class="inline-flex items-center rounded bg-slate-100 px-2 py-0.5"
                                    title="{{ doc.workflow_id }}">
                                    <svg class="h-3 w-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd"
                                            d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"
                                            clip-rule="evenodd" />
                                    </svg>
                                    {{ doc.workflow_id }}
                                </span>
                                <span title="Document ID">ID: {{ doc.document_id|slice:":8" }}...</span>
                                {% if doc.collection_id %}
                                <span title="Collection ID">Coll: {{ doc.collection_id|slice:":8" }}...</span>
                                {% endif %}
                            </div>

                            <!-- User Attribution & Access (New) -->
                            <div class="flex items-center gap-4 text-xs pt-1">
                                <div class="flex items-center gap-1.5"
                                    title="Created By: {{ doc.created_by.username|default:'System' }}">
                                    <div
                                        class="h-5 w-5 rounded-full bg-slate-200 flex items-center justify-center text-[10px] font-bold text-slate-600">
                                        {{ doc.created_by.first_name|slice:":1"|default:"S" }}
                                    </div>
                                    <span class="text-slate-600">{{ doc.created_by.first_name|default:"System" }}</span>
                                </div>
                                {% if request.is_simulated_user %}
                                <div class="flex items-center gap-1.5" title="Simulated Access Check">
                                    <svg class="h-3.5 w-3.5 text-slate-400" fill="none" viewBox="0 0 24 24"
                                        stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                    </svg>
                                    {% if doc.created_by_id == request.user.id %}
                                    <span class="text-green-600 font-medium">Owner</span>
                                    {% else %}
                                    <span class="text-slate-500">Read</span>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex items-center gap-1">
                            <!-- Download Button -->
                            <a href="{{ doc.download_url }}" target="_blank"
                                class="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors"
                                title="Download Original">
                                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                            </a>

                            <!-- Delete Dropdown -->
                            <div x-data="{ open: false }" class="relative">
                                <button @click="open = !open" @click.outside="open = false"
                                    class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                                    title="Delete Document">
                                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                                <div x-show="open" x-transition
                                    class="absolute right-0 mt-1 w-44 rounded-lg bg-white shadow-lg ring-1 ring-slate-200 z-10">
                                    <div class="py-1">
                                        {% if doc.lifecycle_state == 'retired' or doc.lifecycle_state == 'archived' %}
                                        <button hx-post="{% url 'document_restore' %}?document_id={{ doc.document_id }}"
                                            hx-confirm="Dokument wiederherstellen?" hx-target="closest article"
                                            hx-swap="outerHTML" @click="open = false"
                                            class="w-full text-left px-4 py-2 text-sm text-green-700 hover:bg-green-50 flex items-center gap-2">
                                            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                            </svg>
                                            Restore (Active)
                                        </button>
                                        <div class="border-t border-slate-100 my-1"></div>
                                        {% endif %}
                                        <button
                                            hx-delete="{% url 'document_delete' %}?document_id={{ doc.document_id }}&hard=false"
                                            hx-confirm="Dokument archivieren (Soft Delete)?" hx-target="closest article"
                                            hx-swap="outerHTML" @click="open = false"
                                            class="w-full text-left px-4 py-2 text-sm text-amber-700 hover:bg-amber-50 flex items-center gap-2">
                                            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                                            </svg>
                                            Soft Delete (Retire)
                                        </button>
                                        <button
                                            hx-delete="{% url 'document_delete' %}?document_id={{ doc.document_id }}&hard=true"
                                            hx-confirm="Dokument PERMANENT löschen? Diese Aktion kann nicht rückgängig gemacht werden!"
                                            hx-target="closest article" hx-swap="outerHTML" @click="open = false"
                                            class="w-full text-left px-4 py-2 text-sm text-red-700 hover:bg-red-50 flex items-center gap-2">
                                            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                            </svg>
                                            Hard Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Technical Metadata Tabs -->
                    <div class="mt-4" x-data="{ activeTab: 'content' }">
                        <!-- Tab Navigation -->
                        <div class="flex border-b border-slate-200 gap-1 mb-3 overflow-x-auto">
                            <button @click="activeTab = 'content'"
                                :class="activeTab === 'content' ? 'border-indigo-500 text-indigo-600 bg-indigo-50' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'"
                                class="px-3 py-1.5 text-xs font-medium border-b-2 transition-colors flex items-center gap-1 whitespace-nowrap rounded-t-md">
                                <svg class="h-3.5 w-3.5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd"
                                        d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"
                                        clip-rule="evenodd" />
                                </svg>
                                Content
                            </button>
                            <button @click="activeTab = 'lifecycle'"
                                :class="activeTab === 'lifecycle' ? 'border-indigo-500 text-indigo-600 bg-indigo-50' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'"
                                class="px-3 py-1.5 text-xs font-medium border-b-2 transition-colors flex items-center gap-1 whitespace-nowrap rounded-t-md">
                                <svg class="h-3.5 w-3.5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd"
                                        d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"
                                        clip-rule="evenodd" />
                                </svg>
                                Lifecycle
                            </button>
                            {% if doc.ingestion.trace_id or doc.ingestion.run_id %}
                            <button @click="activeTab = 'tracing'"
                                :class="activeTab === 'tracing' ? 'border-indigo-500 text-indigo-600 bg-indigo-50' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'"
                                class="px-3 py-1.5 text-xs font-medium border-b-2 transition-colors flex items-center gap-1 whitespace-nowrap rounded-t-md">
                                <svg class="h-3.5 w-3.5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd"
                                        d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3z"
                                        clip-rule="evenodd" />
                                </svg>
                                Tracing
                            </button>
                            {% endif %}
                            <button @click="activeTab = 'access'"
                                :class="activeTab === 'access' ? 'border-indigo-500 text-indigo-600 bg-indigo-50' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'"
                                class="px-3 py-1.5 text-xs font-medium border-b-2 transition-colors flex items-center gap-1 whitespace-nowrap rounded-t-md">
                                <svg class="h-3.5 w-3.5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"
                                        clip-rule="evenodd" />
                                </svg>
                                Access
                            </button>
                            {% if doc.meta.parse_stats %}
                            <button @click="activeTab = 'stats'"
                                :class="activeTab === 'stats' ? 'border-indigo-500 text-indigo-600 bg-indigo-50' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'"
                                class="px-3 py-1.5 text-xs font-medium border-b-2 transition-colors flex items-center gap-1 whitespace-nowrap rounded-t-md">
                                <svg class="h-3.5 w-3.5" fill="currentColor" viewBox="0 0 20 20">
                                    <path
                                        d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z" />
                                </svg>
                                Stats
                            </button>
                            {% endif %}
                            {% if doc.external_ref_items %}
                            <button @click="activeTab = 'external'"
                                :class="activeTab === 'external' ? 'border-indigo-500 text-indigo-600 bg-indigo-50' : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'"
                                class="px-3 py-1.5 text-xs font-medium border-b-2 transition-colors flex items-center gap-1 whitespace-nowrap rounded-t-md">
                                <svg class="h-3.5 w-3.5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd"
                                        d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z"
                                        clip-rule="evenodd" />
                                </svg>
                                External
                            </button>
                            {% endif %}
                        </div>

                        <!-- Tab Panels -->
                        <div class="bg-slate-50 rounded-lg p-3 text-xs">
                            <!-- Content Tab -->
                            <div x-show="activeTab === 'content'" class="space-y-2">
                                <div class="grid grid-cols-2 gap-x-4 gap-y-2">
                                    <div>
                                        <span class="text-slate-500">Source</span>
                                        <p class="font-medium text-slate-900">{{ doc.source|default:"crawler" }}</p>
                                    </div>
                                    <div>
                                        <span class="text-slate-500">Media Type</span>
                                        <p class="font-mono text-slate-900">
                                            {{ doc.blob.media_type_display|default:"text/html" }}
                                        </p>
                                    </div>
                                    <div>
                                        <span class="text-slate-500">Size</span>
                                        <p class="font-medium text-slate-900">{{ doc.blob.size_display|default:"—" }}
                                        </p>
                                    </div>
                                </div>
                                {% if doc.blob.sha256 %}
                                <div class="pt-2 border-t border-slate-200">
                                    <span class="text-slate-500">SHA256</span>
                                    <p class="font-mono text-slate-700 text-[10px] break-all select-all"
                                        title="Click to select">{{ doc.blob.sha256 }}</p>
                                </div>
                                {% endif %}
                                {% if doc.checksum %}
                                <div>
                                    <span class="text-slate-500">Checksum</span>
                                    <p class="font-mono text-slate-700 text-[10px] break-all select-all"
                                        title="{{ doc.checksum }}">{{ doc.checksum|slice:":12" }}...</p>
                                </div>
                                {% endif %}
                            </div>

                            <!-- Lifecycle Tab -->
                            <div x-show="activeTab === 'lifecycle'" class="space-y-2">
                                <div class="grid grid-cols-2 gap-x-4 gap-y-2">
                                    <div>
                                        <span class="text-slate-500">State</span>
                                        <p class="font-medium"><span
                                                class="inline-flex items-center rounded-full px-2 py-0.5 text-xs {% if doc.lifecycle_state == 'active' %}bg-green-100 text-green-700{% elif doc.lifecycle_state == 'archived' %}bg-amber-100 text-amber-700{% else %}bg-slate-200 text-slate-600{% endif %}">{{
                                                doc.lifecycle_state }}</span></p>
                                    </div>
                                    <div>
                                        <span class="text-slate-500">Created</span>
                                        <p class="font-medium text-slate-900">{{ doc.created_at|date:"Y-m-d H:i" }}</p>
                                    </div>
                                    {% if doc.ingestion.changed_at %}
                                    <div>
                                        <span class="text-slate-500">Changed</span>
                                        <p class="font-medium text-slate-900">{{ doc.ingestion.changed_at|date:"Y-m-d
                                            H:i" }}</p>
                                    </div>
                                    {% endif %}
                                    {% if doc.ingestion.reason %}
                                    <div>
                                        <span class="text-slate-500">Reason</span>
                                        <p class="font-medium text-slate-900">{{ doc.ingestion.reason }}</p>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="pt-2 border-t border-slate-200">
                                    <span class="text-slate-500">Document ID</span>
                                    <p class="font-mono text-slate-700 text-[10px] select-all">{{ doc.document_id }}</p>
                                </div>
                                {% if doc.collection_id %}
                                <div>
                                    <span class="text-slate-500">Collection ID</span>
                                    <p class="font-mono text-slate-700 text-[10px] select-all">{{ doc.collection_id }}
                                    </p>
                                </div>
                                {% endif %}
                                {% if doc.version %}
                                <div>
                                    <span class="text-slate-500">Version</span>
                                    <p class="font-mono text-slate-700">{{ doc.version }}</p>
                                </div>
                                {% endif %}
                            </div>

                            <!-- Tracing Tab -->
                            <div x-show="activeTab === 'tracing'" class="space-y-2">
                                {% if doc.ingestion.trace_id %}
                                <div>
                                    <span class="text-slate-500">Trace ID</span>
                                    <p class="font-mono text-slate-700 text-[10px] select-all break-all">{{
                                        doc.ingestion.trace_id }}</p>
                                </div>
                                {% endif %}
                                {% if doc.ingestion.run_id %}
                                <div>
                                    <span class="text-slate-500">Run ID</span>
                                    <p class="font-mono text-slate-700 text-[10px] select-all break-all">{{
                                        doc.ingestion.run_id }}</p>
                                </div>
                                {% endif %}
                                {% if doc.ingestion.ingestion_run_id %}
                                <div>
                                    <span class="text-slate-500">Ingestion Run ID</span>
                                    <p class="font-mono text-slate-700 text-[10px] select-all break-all">{{
                                        doc.ingestion.ingestion_run_id }}</p>
                                </div>
                                {% endif %}
                                <div class="pt-2 border-t border-slate-200">
                                    <span class="text-slate-500">Workflow</span>
                                    <p class="font-mono text-slate-700">{{ doc.workflow_id }}</p>
                                </div>
                            </div>

                            <!-- Access Tab -->
                            <div x-show="activeTab === 'access'" class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <span class="text-slate-500 block mb-1">Created By</span>
                                        <div class="flex items-center gap-2">
                                            <div
                                                class="h-6 w-6 rounded-full bg-indigo-100 flex items-center justify-center text-xs font-bold text-indigo-700">
                                                {{ doc.created_by.first_name|slice:":1"|default:"S" }}
                                            </div>
                                            <div>
                                                <p class="font-medium text-slate-900">{{
                                                    doc.created_by.username|default:"System" }}</p>
                                                <p class="text-[10px] text-slate-500">{{
                                                    doc.created_by.email|default:"system@internal" }}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <span class="text-slate-500 block mb-1">Role</span>
                                        <span
                                            class="inline-flex items-center rounded-md bg-slate-100 px-2 py-1 text-xs font-medium text-slate-600">
                                            {{ doc.created_by.profile.role|default:"System" }}
                                        </span>
                                    </div>
                                </div>
                                <div class="pt-3 border-t border-slate-200">
                                    <span class="text-slate-500 block mb-2">Effective Permissions</span>
                                    <div class="bg-slate-50 rounded p-2 text-xs text-slate-600 space-y-1">
                                        <div class="flex justify-between">
                                            <span>Owner</span>
                                            <span class="font-mono">{{ doc.created_by_id }}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Simulated User</span>
                                            <span class="font-mono">{{ request.user.id }}</span>
                                        </div>
                                        <div class="mt-2 flex items-center gap-2">
                                            <svg class="h-4 w-4 {% if doc.created_by_id == request.user.id %}text-green-500{% else %}text-slate-400{% endif %}"
                                                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                            <span
                                                class="font-medium {% if doc.created_by_id == request.user.id %}text-green-700{% else %}text-slate-600{% endif %}">
                                                {% if doc.created_by_id == request.user.id %}
                                                Write Access (Owner)
                                                {% else %}
                                                Read Access
                                                {% endif %}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Stats Tab -->
                            <div x-show="activeTab === 'stats'" class="space-y-2">
                                <div class="grid grid-cols-3 gap-4 text-center">
                                    {% if doc.meta.parse_stats.text_blocks_extracted %}
                                    <div class="bg-white rounded-lg p-2 border border-slate-200">
                                        <p class="text-2xl font-bold text-indigo-600">{{
                                            doc.meta.parse_stats.text_blocks_extracted }}</p>
                                        <p class="text-slate-500">Text Blocks</p>
                                    </div>
                                    {% endif %}
                                    {% if doc.meta.parse_stats.assets_extracted %}
                                    <div class="bg-white rounded-lg p-2 border border-slate-200">
                                        <p class="text-2xl font-bold text-indigo-600">{{
                                            doc.meta.parse_stats.assets_extracted }}</p>
                                        <p class="text-slate-500">Assets</p>
                                    </div>
                                    {% endif %}
                                    {% if doc.assets %}
                                    <div class="bg-white rounded-lg p-2 border border-slate-200">
                                        <p class="text-2xl font-bold text-green-600">{{ doc.assets|length }}</p>
                                        <p class="text-slate-500">Stored</p>
                                    </div>
                                    {% endif %}
                                </div>
                                {% if doc.meta.parse_stats %}
                                <div class="pt-2 border-t border-slate-200 grid grid-cols-2 gap-2">
                                    {% for key, value in doc.meta.parse_stats.items %}
                                    <div class="flex justify-between">
                                        <span class="text-slate-500">{{ key }}</span>
                                        <span class="font-mono text-slate-700">{{ value }}</span>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>

                            <!-- External Tab -->
                            <div x-show="activeTab === 'external'" class="space-y-2">
                                {% for item in doc.external_ref_items %}
                                <div class="flex justify-between items-start gap-2">
                                    <span class="text-slate-500 shrink-0">{{ item.key }}</span>
                                    <span class="font-mono text-slate-700 text-right break-all select-all">{{ item.value
                                        }}</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Tags -->
                    {% if doc.tags %}
                    <div class="mt-3 flex flex-wrap gap-2">
                        {% for tag in doc.tags %}
                        <span
                            class="inline-flex items-center rounded-full bg-indigo-50 px-2.5 py-0.5 text-xs font-medium text-indigo-700 border border-indigo-200">
                            {{ tag }}
                        </span>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <!-- Assets Section -->
                    {% if doc.assets %}
                    <div class="mt-4 border-t border-slate-200 pt-4" x-data="{ assetsOpen: false }">
                        <button @click="assetsOpen = !assetsOpen"
                            class="flex items-center justify-between w-full text-left">
                            <span class="text-sm font-medium text-slate-700 flex items-center gap-2">
                                <svg class="h-4 w-4 text-indigo-600" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                Assets ({{ doc.assets|length }})
                            </span>
                            <svg class="h-4 w-4 text-slate-400 transition-transform"
                                :class="{ 'rotate-180': assetsOpen }" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div x-show="assetsOpen" x-collapse class="mt-3">
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                                {% for asset in doc.assets %}
                                <a href="{{ asset.serve_url }}" target="_blank"
                                    class="group relative bg-slate-50 rounded-lg border border-slate-200 overflow-hidden hover:border-indigo-300 hover:shadow-sm transition-all">
                                    {% if asset.is_image %}
                                    <div
                                        class="aspect-square bg-slate-100 flex items-center justify-center overflow-hidden">
                                        <img src="{{ asset.serve_url }}"
                                            alt="{{ asset.text_description|default:'Asset' }}"
                                            class="max-h-full max-w-full object-contain" loading="lazy">
                                    </div>
                                    {% else %}
                                    <div class="aspect-square bg-slate-100 flex items-center justify-center">
                                        <svg class="h-8 w-8 text-slate-400" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                        </svg>
                                    </div>
                                    {% endif %}
                                    <div class="p-2">
                                        <p class="text-xs text-slate-600 truncate">{{
                                            asset.text_description|default:asset.media_type }}</p>
                                        <span class="text-[10px] text-slate-400">{{ asset.blob.type }}</span>
                                    </div>
                                </a>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </article>
                {% endfor %}
            </div>
            {% else %}
            <div
                class="flex flex-col items-center justify-center h-64 rounded-xl border border-dashed border-slate-300 bg-slate-50 text-slate-500">
                <svg class="h-10 w-10 mb-3 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <p>No documents found matching your criteria.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>