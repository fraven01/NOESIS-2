{% extends 'theme/base.html' %}
{% load static %}

{% block title %}Document Space – NOESIS 2{% endblock %}

{% block content %}
<div class="mx-auto max-w-6xl space-y-10 px-6 py-10">
  <header class="space-y-3">
    <p class="text-sm font-semibold uppercase tracking-wide text-slate-500">Developer Workbench</p>
    <h1 class="text-3xl font-semibold tracking-tight text-slate-900">Document Space Explorer</h1>
    <p class="max-w-3xl text-sm text-slate-600">
      Untersuche alle dokumentierten Collections eines Mandanten, prüfe Metadaten und lade Rohdokumente herunter.
      Die Ansicht zeigt Quelle, Lifecycle-State sowie Trace-Informationen der letzten Ingestion.
    </p>
    <p class="text-xs text-slate-500">
      Scope:
      <code class="rounded bg-slate-100 px-1 py-0.5 text-[11px]">X-Tenant-ID: {{ tenant_id }}</code>
      <code class="rounded bg-slate-100 px-1 py-0.5 text-[11px]">X-Tenant-Schema: {{ tenant_schema }}</code>
    </p>
  </header>

  <section class="space-y-4 rounded-xl border border-slate-200 bg-white p-6 shadow-sm">
    <div class="flex items-center justify-between gap-4">
      <div>
        <h2 class="text-xl font-semibold text-slate-900">Document Collections</h2>
        <p class="text-sm text-slate-600">
          Übersicht der aktuell bekannten Collections inkl. Case-Bezug und Typisierung.
        </p>
      </div>
      <span class="rounded-full bg-slate-100 px-3 py-1 text-xs font-medium text-slate-600">
        {{ collections|length }} Collections
      </span>
    </div>

    {% if collections %}
      <div class="grid gap-4 lg:grid-cols-2">
        {% for collection in collections %}
          <article class="rounded-lg border {% if selected_collection and selected_collection.id == collection.id %}border-indigo-500 ring-1 ring-indigo-200{% else %}border-slate-200{% endif %} bg-white p-4 shadow-sm">
            <div class="flex items-start justify-between gap-3">
              <div>
                <p class="text-xs uppercase tracking-wide text-slate-500">{{ collection.key }}</p>
                <h3 class="text-lg font-semibold text-slate-900">{{ collection.name }}</h3>
              </div>
              {% if selected_collection and selected_collection.id == collection.id %}
                <span class="rounded-full bg-indigo-50 px-3 py-1 text-xs font-medium text-indigo-700">aktiv</span>
              {% endif %}
            </div>

            <dl class="mt-4 grid grid-cols-1 gap-x-4 gap-y-2 text-sm text-slate-600 sm:grid-cols-2">
              <div>
                <dt class="text-xs uppercase tracking-wide text-slate-500">Collection ID</dt>
                <dd class="break-all font-mono text-xs text-slate-800">{{ collection.collection_id }}</dd>
              </div>
              <div>
                <dt class="text-xs uppercase tracking-wide text-slate-500">Logical ID</dt>
                <dd class="break-all font-mono text-xs text-slate-800">{{ collection.id }}</dd>
              </div>
              <div>
                <dt class="text-xs uppercase tracking-wide text-slate-500">Typ · Visibility</dt>
                <dd>{{ collection.type|default:"—" }} · {{ collection.visibility|default:"—" }}</dd>
              </div>
              <div>
                <dt class="text-xs uppercase tracking-wide text-slate-500">Updated</dt>
                <dd>{{ collection.updated_at|date:"Y-m-d H:i" }}</dd>
              </div>
              {% if collection.case %}
                <div class="sm:col-span-2">
                  <dt class="text-xs uppercase tracking-wide text-slate-500">Case</dt>
                  <dd class="flex flex-wrap gap-2 text-sm">
                    <span class="rounded bg-slate-100 px-2 py-0.5 font-mono text-xs text-slate-700">{{ collection.case.external_id }}</span>
                    <span>{{ collection.case.title|default:"(ohne Titel)" }}</span>
                    <span class="text-xs uppercase tracking-wide text-slate-500">{{ collection.case.status }}</span>
                  </dd>
                </div>
              {% endif %}
            </dl>

            {% if collection.metadata %}
              <div class="mt-4 space-y-1">
                <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Metadata</p>
                <dl class="divide-y divide-slate-100 text-xs text-slate-600">
                  {% for meta in collection.metadata %}
                    <div class="flex items-start justify-between gap-4 py-1">
                      <dt class="font-medium text-slate-700">{{ meta.key }}</dt>
                      <dd class="flex-1 text-right font-mono">{{ meta.value }}</dd>
                    </div>
                  {% endfor %}
                </dl>
              </div>
            {% endif %}
          </article>
        {% endfor %}
      </div>
    {% else %}
      <div class="rounded border border-dashed border-slate-200 bg-slate-50 p-6 text-center text-sm text-slate-600">
        Keine Collections registriert. Lege zuerst Collections über den RAG-Ingestion-Fluss an.
      </div>
    {% endif %}
  </section>

  <section class="space-y-6 rounded-xl border border-slate-200 bg-white p-6 shadow-sm">
    <div>
      <h2 class="text-xl font-semibold text-slate-900">Filter &amp; Suche</h2>
      <p class="text-sm text-slate-600">Wähle eine Collection, setze optionale Filter und inspiziere anschließend die Dokumente.</p>
    </div>

    {% if collection_warning %}
      <p class="rounded border border-amber-200 bg-amber-50 px-3 py-2 text-sm text-amber-800">
        Die angegebene Collection konnte nicht gefunden werden – es wurde die erste verfügbare Collection vorausgewählt.
      </p>
    {% endif %}

    {% if documents_error %}
      <p class="rounded border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700">{{ documents_error }}</p>
    {% endif %}

    <form method="get" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
      <div class="space-y-1 sm:col-span-2">
        <label for="collection-select" class="text-sm font-medium text-slate-700">Collection</label>
        <select
          id="collection-select"
          name="collection"
          class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
          {% if not has_collections %}disabled{% endif %}
        >
          {% for collection in collections %}
            <option value="{{ collection.selector }}" {% if collection.selector == selected_collection_identifier %}selected{% endif %}>
              {{ collection.name }} · {{ collection.key }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="space-y-1">
        <label for="search-term" class="text-sm font-medium text-slate-700">Freitextsuche</label>
        <input
          id="search-term"
          name="q"
          type="text"
          placeholder="z. B. Dokument-ID, Titel, Provider…"
          value="{{ search_term }}"
          class="block w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
        />
      </div>

      <div class="space-y-1">
        <label for="workflow-filter" class="text-sm font-medium text-slate-700">Workflow Filter</label>
        <input
          id="workflow-filter"
          name="workflow"
          type="text"
          placeholder="workflow-id"
          value="{{ workflow_filter }}"
          class="block w-full rounded-md border border-slate-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
        />
      </div>

      <div class="space-y-1">
        <label for="limit-select" class="text-sm font-medium text-slate-700">Result Limit</label>
        <select
          id="limit-select"
          name="limit"
          class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
        >
          {% for option in limit_options %}
            <option value="{{ option }}" {% if option == limit %}selected{% endif %}>{{ option }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="flex items-center gap-2">
        <input
          id="latest-checkbox"
          name="latest"
          type="checkbox"
          value="1"
          {% if latest_only %}checked{% endif %}
          class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"
        />
        <label for="latest-checkbox" class="text-sm text-slate-700">Nur letzte Version pro Dokument</label>
      </div>

      <div class="sm:col-span-2 lg:col-span-3 flex flex-wrap items-center gap-3">
        <button
          type="submit"
          class="inline-flex items-center rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
        >
          Filter anwenden
        </button>
        {% if cursor %}
          <span class="text-xs text-slate-500">Aktiver Cursor: <code class="font-mono text-[11px]">{{ cursor }}</code></span>
        {% endif %}
      </div>
    </form>
  </section>

  {% if selected_collection %}
    <section class="space-y-4 rounded-xl border border-slate-200 bg-white p-6 shadow-sm">
      <div class="flex flex-wrap items-center justify-between gap-4">
        <div>
          <h2 class="text-xl font-semibold text-slate-900">Dokumentenübersicht</h2>
          <p class="text-sm text-slate-600">
            Zeigt {{ document_summary.displayed }} von {{ document_summary.fetched }} geladenen Dokumenten (Limit {{ document_summary.limit }}).
          </p>
        </div>
        <div class="text-right">
          {% if selected_collection %}
            <p class="text-xs uppercase tracking-wide text-slate-500">Aktive Collection</p>
            <p class="font-mono text-xs text-slate-700">{{ selected_collection.collection_id }}</p>
          {% endif %}
        </div>
      </div>

      <div class="grid gap-4 md:grid-cols-2">
        <div class="rounded-lg border border-slate-100 bg-slate-50 p-4">
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Quellen</p>
          {% if summaries.sources %}
            <dl class="mt-2 space-y-1 text-sm text-slate-700">
              {% for entry in summaries.sources %}
                <div class="flex items-center justify-between gap-3">
                  <dt class="capitalize">{{ entry.label }}</dt>
                  <dd class="font-semibold">{{ entry.count }}</dd>
                </div>
              {% endfor %}
            </dl>
          {% else %}
            <p class="mt-2 text-sm text-slate-500">Keine Daten.</p>
          {% endif %}
        </div>
        <div class="rounded-lg border border-slate-100 bg-slate-50 p-4">
          <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Lifecycle</p>
          {% if summaries.lifecycle %}
            <dl class="mt-2 space-y-1 text-sm text-slate-700">
              {% for entry in summaries.lifecycle %}
                <div class="flex items-center justify-between gap-3">
                  <dt class="capitalize">{{ entry.label }}</dt>
                  <dd class="font-semibold">{{ entry.count }}</dd>
                </div>
              {% endfor %}
            </dl>
          {% else %}
            <p class="mt-2 text-sm text-slate-500">Keine Daten.</p>
          {% endif %}
        </div>
      </div>
    </section>

    <section class="space-y-4">
      {% if documents %}
        {% for doc in documents %}
          <article class="space-y-4 rounded-xl border border-slate-200 bg-white p-6 shadow-sm">
            <div class="flex flex-col gap-4 md:flex-row md:items-start md:justify-between">
              <div class="space-y-2">
                <p class="text-xs uppercase tracking-wide text-slate-500">{{ doc.workflow_id }}</p>
                <h3 class="text-2xl font-semibold text-slate-900">
                  {{ doc.title|default:"(Ohne Titel)" }}
                </h3>
                <p class="text-sm text-slate-500">Document ID · <code class="font-mono text-xs">{{ doc.document_id }}</code></p>
                <p class="text-sm text-slate-500">Collection ID · <code class="font-mono text-xs">{{ doc.collection_id|default:"—" }}</code></p>
                {% if doc.document_collection_id %}
                  <p class="text-sm text-slate-500">Logical Collection · <code class="font-mono text-xs">{{ doc.document_collection_id }}</code></p>
                {% endif %}
              </div>
              <div class="text-right">
                <a
                  href="{{ doc.download_url }}"
                  class="inline-flex items-center justify-center rounded-md border border-indigo-200 bg-indigo-50 px-4 py-2 text-sm font-medium text-indigo-700 shadow-sm hover:bg-indigo-100"
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  Download
                </a>
                <p class="mt-2 text-xs text-slate-500">Blob: {{ doc.blob.type|default:"n/a" }} · {{ doc.blob.size_display|default:"—" }}</p>
                {% if doc.blob.media_type_display %}
                  <p class="text-xs text-slate-500">MIME: {{ doc.blob.media_type_display }}</p>
                {% endif %}
              </div>
            </div>

            <div class="grid gap-6 md:grid-cols-2">
              <dl class="space-y-1 text-sm text-slate-700">
                <div>
                  <dt class="text-xs uppercase tracking-wide text-slate-500">Quelle</dt>
                  <dd class="capitalize">{{ doc.source|default:"unbekannt" }}</dd>
                </div>
                <div>
                  <dt class="text-xs uppercase tracking-wide text-slate-500">Erstellt</dt>
                  <dd>{{ doc.created_at|date:"Y-m-d H:i" }}</dd>
                </div>
                <div>
                  <dt class="text-xs uppercase tracking-wide text-slate-500">Sprache</dt>
                  <dd>{{ doc.language|upper|default:"—" }}</dd>
                </div>
                {% if doc.origin_uri %}
                  <div>
                    <dt class="text-xs uppercase tracking-wide text-slate-500">Origin</dt>
                    <dd>
                      <a href="{{ doc.origin_uri }}" class="text-indigo-600 hover:underline" target="_blank" rel="noopener noreferrer">{{ doc.origin_uri }}</a>
                    </dd>
                  </div>
                {% endif %}
                {% if doc.tags %}
                  <div class="space-y-1">
                    <dt class="text-xs uppercase tracking-wide text-slate-500">Tags</dt>
                    <dd class="flex flex-wrap gap-2">
                      {% for tag in doc.tags %}
                        <span class="rounded-full bg-slate-100 px-2 py-0.5 text-xs text-slate-800">{{ tag }}</span>
                      {% endfor %}
                    </dd>
                  </div>
                {% endif %}
              </dl>

              <dl class="space-y-1 text-sm text-slate-700">
                <div>
                  <dt class="text-xs uppercase tracking-wide text-slate-500">Lifecycle State</dt>
                  <dd class="font-semibold capitalize">{{ doc.ingestion.state|default:doc.lifecycle_state }}</dd>
                </div>
                {% if doc.ingestion.changed_at %}
                  <div>
                    <dt class="text-xs uppercase tracking-wide text-slate-500">Geändert</dt>
                    <dd>{{ doc.ingestion.changed_at|date:"Y-m-d H:i" }}</dd>
                  </div>
                {% endif %}
                {% if doc.ingestion.trace_id %}
                  <div>
                    <dt class="text-xs uppercase tracking-wide text-slate-500">Trace ID</dt>
                    <dd class="font-mono text-xs">{{ doc.ingestion.trace_id }}</dd>
                  </div>
                {% endif %}
                {% if doc.ingestion.run_id %}
                  <div>
                    <dt class="text-xs uppercase tracking-wide text-slate-500">Run ID</dt>
                    <dd class="font-mono text-xs">{{ doc.ingestion.run_id }}</dd>
                  </div>
                {% endif %}
                {% if doc.ingestion.ingestion_run_id %}
                  <div>
                    <dt class="text-xs uppercase tracking-wide text-slate-500">Ingestion Run</dt>
                    <dd class="font-mono text-xs">{{ doc.ingestion.ingestion_run_id }}</dd>
                  </div>
                {% endif %}
                {% if doc.ingestion.reason %}
                  <div>
                    <dt class="text-xs uppercase tracking-wide text-slate-500">Begründung</dt>
                    <dd class="text-sm text-slate-600">{{ doc.ingestion.reason }}</dd>
                  </div>
                {% endif %}
                {% if doc.ingestion.policy_events %}
                  <div>
                    <dt class="text-xs uppercase tracking-wide text-slate-500">Policy Events</dt>
                    <dd class="flex flex-wrap gap-2">
                      {% for event in doc.ingestion.policy_events %}
                        <span class="rounded bg-amber-50 px-2 py-0.5 text-xs text-amber-700">{{ event }}</span>
                      {% endfor %}
                    </dd>
                  </div>
                {% endif %}
              </dl>
            </div>

            <div class="grid gap-4 md:grid-cols-2">
              <div class="space-y-1 text-xs text-slate-600">
                <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Blob Details</p>
                <p>URI: <span class="break-all font-mono text-[11px]">{{ doc.blob.uri|default:"n/a" }}</span></p>
                <p>Checksum: <span class="break-all font-mono text-[11px]">{{ doc.checksum }}</span></p>
                {% if doc.blob.sha256 %}
                  <p>Blob SHA: <span class="break-all font-mono text-[11px]">{{ doc.blob.sha256 }}</span></p>
                {% endif %}
              </div>
              {% if doc.external_ref_items %}
                <div class="space-y-1 text-xs text-slate-600">
                  <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">External Reference</p>
                  <dl class="divide-y divide-slate-100">
                    {% for item in doc.external_ref_items %}
                      <div class="flex items-start justify-between gap-3 py-1">
                        <dt class="font-medium text-slate-700">{{ item.key }}</dt>
                        <dd class="flex-1 text-right font-mono">{{ item.value }}</dd>
                      </div>
                    {% endfor %}
                  </dl>
                </div>
              {% endif %}
            </div>
          </article>
        {% endfor %}
      {% else %}
        <div class="rounded border border-dashed border-slate-200 bg-white p-6 text-center text-sm text-slate-600">
          Keine Dokumente für die aktuelle Auswahl gefunden.
        </div>
      {% endif %}
    </section>

    {% if next_query %}
      <section class="text-center">
        <a
          class="inline-flex items-center rounded-md border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700 shadow-sm hover:bg-slate-50"
          href="?{{ next_query|urlencode }}"
        >
          Weitere Ergebnisse laden
        </a>
      </section>
    {% endif %}
  {% endif %}
</div>
{% endblock %}
