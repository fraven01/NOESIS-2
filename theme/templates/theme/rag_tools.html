{% extends 'theme/base.html' %}

{% block title %}RAG Workbench · NOESIS 2{% endblock %}

{% block content %}
<div class="space-y-10">
  <header class="space-y-3">
    <p class="text-xs uppercase tracking-wider text-slate-500">Architecture-aligned tooling</p>
    <h1 class="text-3xl font-semibold tracking-tight text-slate-900">RAG Operations Workbench</h1>
    <p class="max-w-3xl text-sm text-slate-600">
      Alle Aktionen laufen serverseitig über die produktiven Services von NOESIS 2. Die Werkbank
      verpackt Upload, Ingestion und Retrieval in geprüfte Django-Workflows – inklusive Tenancy-Headern,
      Idempotenz und Resolver-Hints. Nutze sie für Smoke-Tests oder manuelle Backfills, ohne die
      Architekturleitlinien zu verletzen.
    </p>
  </header>

  <section class="grid gap-6 lg:grid-cols-3">
    <div class="rounded-lg border border-slate-200 bg-white p-5 shadow-sm">
      <h2 class="text-sm font-semibold text-slate-700">Mandantenkontext</h2>
      <dl class="mt-3 space-y-2 text-sm text-slate-600">
        <div class="flex items-center justify-between">
          <dt class="font-medium text-slate-700">X-Tenant-ID</dt>
          <dd><code class="rounded bg-slate-100 px-2 py-1 text-xs font-mono">{{ tenant_id }}</code></dd>
        </div>
        <div class="flex items-center justify-between">
          <dt class="font-medium text-slate-700">X-Tenant-Schema</dt>
          <dd><code class="rounded bg-slate-100 px-2 py-1 text-xs font-mono">{{ tenant_schema }}</code></dd>
        </div>
        <div class="flex items-center justify-between">
          <dt class="font-medium text-slate-700">Default Profil</dt>
          <dd><code class="rounded bg-slate-100 px-2 py-1 text-xs font-mono">{{ default_embedding_profile }}</code></dd>
        </div>
      </dl>
      <p class="mt-4 text-xs text-slate-500">
        Die Werte werden aus der Domain abgeleitet und mit jedem Request als Service-Header gesetzt.
      </p>
    </div>
    <div class="rounded-lg border border-slate-200 bg-white p-5 shadow-sm">
      <h2 class="text-sm font-semibold text-slate-700">Resolver Empfehlung</h2>
      <dl class="mt-3 space-y-2 text-sm text-slate-600">
        <div class="flex items-center justify-between">
          <dt class="font-medium text-slate-700">Embedding Profil</dt>
          <dd><code class="rounded bg-slate-100 px-2 py-1 text-xs font-mono">{{ resolver_profile_hint|default:"–" }}</code></dd>
        </div>
        <div class="flex items-center justify-between">
          <dt class="font-medium text-slate-700">Collection Scope</dt>
          <dd><code class="rounded bg-slate-100 px-2 py-1 text-xs font-mono">{{ resolver_collection_hint|default:"–" }}</code></dd>
        </div>
        <div class="flex items-center justify-between">
          <dt class="font-medium text-slate-700">Alias Bridge</dt>
          <dd>
            {% if collection_alias_enabled %}
              <span class="inline-flex items-center rounded bg-emerald-50 px-2 py-0.5 text-xs font-medium text-emerald-700">aktiv</span>
            {% else %}
              <span class="inline-flex items-center rounded bg-slate-100 px-2 py-0.5 text-xs font-medium text-slate-600">deaktiviert</span>
            {% endif %}
          </dd>
        </div>
      </dl>
      <p class="mt-4 text-xs text-slate-500">
        Resolver-Hints definieren Defaults für Collection und Profil. Alle Formulare erlauben Overrides pro Lauf.
      </p>
    </div>
    <div class="rounded-lg border border-slate-200 bg-white p-5 shadow-sm">
      <h2 class="text-sm font-semibold text-slate-700">Hinweise</h2>
      <ul class="mt-3 space-y-2 text-sm text-slate-600">
        <li>Requests sind idempotent und erzeugen Trace-IDs auf Server-Seite.</li>
        <li>Upload &amp; Ingestion persistieren Status im Object Store für spätere Auswertungen.</li>
        <li>Queries laufen über <code class="font-mono">rag.default</code> und geben das produktive Antwortschema zurück.</li>
      </ul>
    </div>
  </section>

  <section class="rounded-lg border border-slate-200 bg-white p-6 shadow-sm space-y-6">
    <div class="space-y-2">
      <h2 class="text-xl font-semibold text-slate-900">1. Dokument hochladen</h2>
      <p class="text-sm text-slate-600">
        Datei wird im Object Store abgelegt, Metadaten validiert und anschließend ein Ingestion-Run via Celery angestoßen.
        Collection-Overrides landen sowohl im Upload-Metadata als auch im Queue-Request.
      </p>
    </div>
    <form method="post" enctype="multipart/form-data" class="space-y-4">
      {% csrf_token %}
      <input type="hidden" name="action" value="upload" />
      {% if upload_form.non_field_errors %}
      <div class="rounded-md border border-red-200 bg-red-50 p-3 text-sm text-red-700">
        {{ upload_form.non_field_errors|join:" " }}
      </div>
      {% endif %}
      <div class="grid gap-4 md:grid-cols-2">
        <div class="space-y-1">
          <label class="block text-sm font-medium text-slate-700" for="{{ upload_form.case_id.id_for_label }}">Case ID</label>
          {{ upload_form.case_id }}
          <p class="text-xs text-slate-500">Wird als <code>X-Case-ID</code> in Upload &amp; Ingestion verwendet.</p>
          {% if upload_form.case_id.errors %}
          <p class="text-xs text-red-600">{{ upload_form.case_id.errors|join:", " }}</p>
          {% endif %}
        </div>
        <div class="space-y-1">
          <label class="block text-sm font-medium text-slate-700" for="{{ upload_form.collection_id.id_for_label }}">Collection (optional)</label>
          {{ upload_form.collection_id }}
          <p class="text-xs text-slate-500">Leer lassen, um Resolver-Default zu verwenden.</p>
          {% if upload_form.collection_id.errors %}
          <p class="text-xs text-red-600">{{ upload_form.collection_id.errors|join:", " }}</p>
          {% endif %}
        </div>
        <div class="space-y-1">
          <label class="block text-sm font-medium text-slate-700" for="{{ upload_form.file.id_for_label }}">Datei</label>
          {{ upload_form.file }}
          {% if upload_form.file.errors %}
          <p class="text-xs text-red-600">{{ upload_form.file.errors|join:", " }}</p>
          {% endif %}
        </div>
        <div class="space-y-1 md:col-span-2">
          <label class="block text-sm font-medium text-slate-700" for="{{ upload_form.metadata.id_for_label }}">Metadata (JSON)</label>
          {{ upload_form.metadata }}
          <p class="text-xs text-slate-500">Optionales JSON-Objekt. Collection wird automatisch ergänzt.</p>
          {% if upload_form.metadata.errors %}
          <p class="text-xs text-red-600">{{ upload_form.metadata.errors|join:", " }}</p>
          {% endif %}
        </div>
      </div>
      <div>
        <button type="submit" class="inline-flex items-center rounded-md bg-slate-900 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2">Upload &amp; Queue</button>
      </div>
    </form>
    {% if upload_result %}
    <div class="rounded-lg border border-slate-200 bg-slate-50 p-4 text-sm">
      <div class="flex items-center justify-between">
        <p class="font-semibold text-slate-700">Upload Response</p>
        <span class="text-xs font-mono text-slate-500">Status: {{ upload_result.status|default:"–" }}</span>
      </div>
      <pre class="mt-3 max-h-72 overflow-auto rounded bg-slate-900 p-4 text-xs text-slate-100">{{ upload_result.formatted }}</pre>
    </div>
    {% endif %}
  </section>

  <section class="grid gap-6 lg:grid-cols-2">
    <div class="space-y-4 rounded-lg border border-slate-200 bg-white p-6 shadow-sm">
      <div class="space-y-2">
        <h2 class="text-xl font-semibold text-slate-900">2. Ingestion Run starten</h2>
        <p class="text-sm text-slate-600">Queue einen Ingestion-Lauf für vorhandene Dokument-IDs mit dem gewünschten Embedding-Profil.</p>
      </div>
      <form method="post" class="space-y-4">
        {% csrf_token %}
        <input type="hidden" name="action" value="ingestion" />
        {% if ingestion_form.non_field_errors %}
        <div class="rounded-md border border-red-200 bg-red-50 p-3 text-sm text-red-700">{{ ingestion_form.non_field_errors|join:" " }}</div>
        {% endif %}
        <div class="grid gap-4">
          <div class="space-y-1">
            <label class="block text-sm font-medium text-slate-700" for="{{ ingestion_form.case_id.id_for_label }}">Case ID</label>
            {{ ingestion_form.case_id }}
            {% if ingestion_form.case_id.errors %}
            <p class="text-xs text-red-600">{{ ingestion_form.case_id.errors|join:", " }}</p>
            {% endif %}
          </div>
          <div class="space-y-1">
            <label class="block text-sm font-medium text-slate-700" for="{{ ingestion_form.collection_id.id_for_label }}">Collection (optional)</label>
            {{ ingestion_form.collection_id }}
            {% if ingestion_form.collection_id.errors %}
            <p class="text-xs text-red-600">{{ ingestion_form.collection_id.errors|join:", " }}</p>
            {% endif %}
          </div>
          <div class="space-y-1">
            <label class="block text-sm font-medium text-slate-700" for="{{ ingestion_form.embedding_profile.id_for_label }}">Embedding Profil</label>
            {{ ingestion_form.embedding_profile }}
            {% if ingestion_form.embedding_profile.errors %}
            <p class="text-xs text-red-600">{{ ingestion_form.embedding_profile.errors|join:", " }}</p>
            {% endif %}
          </div>
          <div class="space-y-1">
            <label class="block text-sm font-medium text-slate-700" for="{{ ingestion_form.document_ids.id_for_label }}">Document IDs</label>
            {{ ingestion_form.document_ids }}
            <p class="text-xs text-slate-500">Kommagetrennt oder zeilenweise angeben.</p>
            {% if ingestion_form.document_ids.errors %}
            <p class="text-xs text-red-600">{{ ingestion_form.document_ids.errors|join:", " }}</p>
            {% endif %}
          </div>
        </div>
        <button type="submit" class="inline-flex items-center rounded-md bg-slate-900 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2">Ingestion queue</button>
      </form>
      {% if ingestion_result %}
      <div class="rounded-lg border border-slate-200 bg-slate-50 p-4 text-sm">
        <div class="flex items-center justify-between">
          <p class="font-semibold text-slate-700">Ingestion Response</p>
          <span class="text-xs font-mono text-slate-500">Status: {{ ingestion_result.status|default:"–" }}</span>
        </div>
        <pre class="mt-3 max-h-60 overflow-auto rounded bg-slate-900 p-4 text-xs text-slate-100">{{ ingestion_result.formatted }}</pre>
      </div>
      {% endif %}
    </div>
    <div class="space-y-4 rounded-lg border border-slate-200 bg-white p-6 shadow-sm">
      <div class="space-y-2">
        <h2 class="text-xl font-semibold text-slate-900">3. Ingestion Status prüfen</h2>
        <p class="text-sm text-slate-600">Liest den zuletzt persistierten Ingestion-Status aus dem Object Store.</p>
      </div>
      <form method="post" class="space-y-4">
        {% csrf_token %}
        <input type="hidden" name="action" value="status" />
        <div class="space-y-1">
          <label class="block text-sm font-medium text-slate-700" for="{{ status_form.case_id.id_for_label }}">Case ID</label>
          {{ status_form.case_id }}
          {% if status_form.case_id.errors %}
          <p class="text-xs text-red-600">{{ status_form.case_id.errors|join:", " }}</p>
          {% endif %}
        </div>
        <button type="submit" class="inline-flex items-center rounded-md bg-slate-900 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2">Status abrufen</button>
      </form>
      {% if status_result %}
      <div class="rounded-lg border border-slate-200 bg-slate-50 p-4 text-sm">
        <div class="flex items-center justify-between">
          <p class="font-semibold text-slate-700">Letzter Ingestion-Run</p>
          <span class="text-xs font-mono text-slate-500">Status: {{ status_result.status|default:"–" }}</span>
        </div>
        <pre class="mt-3 max-h-60 overflow-auto rounded bg-slate-900 p-4 text-xs text-slate-100">{{ status_result.formatted }}</pre>
      </div>
      {% endif %}
    </div>
  </section>

  <section class="rounded-lg border border-slate-200 bg-white p-6 shadow-sm space-y-6">
    <div class="space-y-2">
      <h2 class="text-xl font-semibold text-slate-900">4. RAG Query ausführen</h2>
      <p class="text-sm text-slate-600">
        Anfrage wird über den produktiven Graph <code class="font-mono">rag.default</code> geroutet.
        Optional lassen sich Collection, Visibility und Hybrid-Parameter überschreiben.
      </p>
    </div>
    <form method="post" class="space-y-4">
      {% csrf_token %}
      <input type="hidden" name="action" value="query" />
      {% if query_form.non_field_errors %}
      <div class="rounded-md border border-red-200 bg-red-50 p-3 text-sm text-red-700">{{ query_form.non_field_errors|join:" " }}</div>
      {% endif %}
      <div class="grid gap-4 md:grid-cols-2">
        <div class="space-y-1 md:col-span-2">
          <label class="block text-sm font-medium text-slate-700" for="{{ query_form.query.id_for_label }}">Query</label>
          {{ query_form.query }}
          {% if query_form.query.errors %}
          <p class="text-xs text-red-600">{{ query_form.query.errors|join:", " }}</p>
          {% endif %}
        </div>
        <div class="space-y-1">
          <label class="block text-sm font-medium text-slate-700" for="{{ query_form.case_id.id_for_label }}">Case ID</label>
          {{ query_form.case_id }}
          {% if query_form.case_id.errors %}
          <p class="text-xs text-red-600">{{ query_form.case_id.errors|join:", " }}</p>
          {% endif %}
        </div>
        <div class="space-y-1">
          <label class="block text-sm font-medium text-slate-700" for="{{ query_form.process.id_for_label }}">Process (optional)</label>
          {{ query_form.process }}
          {% if query_form.process.errors %}
          <p class="text-xs text-red-600">{{ query_form.process.errors|join:", " }}</p>
          {% endif %}
        </div>
        <div class="space-y-1">
          <label class="block text-sm font-medium text-slate-700" for="{{ query_form.collection_id.id_for_label }}">Collection</label>
          {{ query_form.collection_id }}
          <datalist id="query-collection-options">
            {% for option in collection_options %}
            <option value="{{ option }}"></option>
            {% endfor %}
          </datalist>
          {% if query_form.collection_id.errors %}
          <p class="text-xs text-red-600">{{ query_form.collection_id.errors|join:", " }}</p>
          {% endif %}
        </div>
        <div class="space-y-1">
          <label class="block text-sm font-medium text-slate-700" for="{{ query_form.visibility.id_for_label }}">Visibility</label>
          {{ query_form.visibility }}
        </div>
        <div class="space-y-1">
          <label class="block text-sm font-medium text-slate-700" for="{{ query_form.alpha.id_for_label }}">alpha</label>
          {{ query_form.alpha }}
        </div>
        <div class="space-y-1">
          <label class="block text-sm font-medium text-slate-700" for="{{ query_form.min_sim.id_for_label }}">min_sim</label>
          {{ query_form.min_sim }}
        </div>
        <div class="space-y-1">
          <label class="block text-sm font-medium text-slate-700" for="{{ query_form.top_k.id_for_label }}">top_k</label>
          {{ query_form.top_k }}
        </div>
        <div class="space-y-1">
          <label class="block text-sm font-medium text-slate-700" for="{{ query_form.vec_limit.id_for_label }}">vec_limit</label>
          {{ query_form.vec_limit }}
        </div>
        <div class="space-y-1">
          <label class="block text-sm font-medium text-slate-700" for="{{ query_form.lex_limit.id_for_label }}">lex_limit</label>
          {{ query_form.lex_limit }}
        </div>
        <div class="space-y-1">
          <label class="block text-sm font-medium text-slate-700" for="{{ query_form.max_candidates.id_for_label }}">max_candidates</label>
          {{ query_form.max_candidates }}
        </div>
        <div class="space-y-1">
          <label class="block text-sm font-medium text-slate-700" for="{{ query_form.trgm_limit.id_for_label }}">trgm_limit</label>
          {{ query_form.trgm_limit }}
        </div>
      </div>
      <div>
        <button type="submit" class="inline-flex items-center rounded-md bg-slate-900 px-4 py-2 text-sm font-medium text-white shadow-sm transition hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2">Query ausführen</button>
      </div>
    </form>
    {% if query_summary %}
    <div class="grid gap-4 lg:grid-cols-3">
      <div class="rounded-lg border border-slate-200 bg-slate-50 p-4">
        <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-600">Antwort</h3>
        <p class="mt-2 whitespace-pre-wrap text-sm text-slate-800">{{ query_summary.answer|default:"Keine Antwort" }}</p>
      </div>
      <div class="rounded-lg border border-slate-200 bg-slate-50 p-4">
        <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-600">Prompt Version</h3>
        <p class="mt-2 text-sm font-mono text-slate-800">{{ query_summary.prompt_version|default:"–" }}</p>
        {% if query_summary.retrieval %}
        <dl class="mt-3 space-y-1 text-xs text-slate-600">
          {% for key, value in query_summary.retrieval.items %}
          <div class="flex items-center justify-between gap-4">
            <dt class="font-medium text-slate-700">{{ key }}</dt>
            <dd class="font-mono">{{ value }}</dd>
          </div>
          {% endfor %}
        </dl>
        {% endif %}
      </div>
      <div class="rounded-lg border border-slate-200 bg-slate-50 p-4">
        <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-600">Snippets</h3>
        {% if query_summary.snippets %}
        <ul class="mt-2 space-y-2 text-xs text-slate-700">
          {% for snippet in query_summary.snippets %}
          <li class="rounded border border-slate-200 bg-white p-2">
            {% if snippet.title %}
            <p class="text-sm font-semibold text-slate-800">{{ snippet.title }}</p>
            {% endif %}
            <p class="mt-1 text-xs text-slate-600 whitespace-pre-wrap">{{ snippet.content|default:snippet.text|default:"–" }}</p>
            <p class="mt-2 text-[11px] uppercase tracking-wide text-slate-400">{{ snippet.document_id|default:"" }}</p>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p class="mt-2 text-sm text-slate-600">Keine Snippets gefunden.</p>
        {% endif %}
      </div>
    </div>
    {% endif %}
    {% if query_result %}
    <div class="rounded-lg border border-slate-200 bg-slate-50 p-4 text-sm">
      <div class="flex items-center justify-between">
        <p class="font-semibold text-slate-700">Query Response</p>
        <span class="text-xs font-mono text-slate-500">Status: {{ query_result.status|default:"–" }}</span>
      </div>
      <pre class="mt-3 max-h-96 overflow-auto rounded bg-slate-900 p-4 text-xs text-slate-100">{{ query_result.formatted }}</pre>
    </div>
    {% endif %}
  </section>
</div>
{% endblock %}
